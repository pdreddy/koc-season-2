<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Player Matchups - KOC Season 2</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root{
          --bg1:#667eea; --bg2:#764ba2; --ink:#1a202c; --muted:#718096; --card:#ffffff;
          --ring:#e2e8f0; --accent:#22d3ee;
        }
        html,body{ height:100%; }
        body{
          font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
          background:linear-gradient(135deg,var(--bg1),var(--bg2));
          min-height:100vh; color:var(--ink);
        }

        .header{ position:sticky; top:0; z-index:50; backdrop-filter:blur(10px); }
        .header-bar{
          display:flex; align-items:center; justify-content:space-between;
          max-width:1100px; margin:0 auto; padding:.75rem 1rem;
          background:rgba(255,255,255,.95); box-shadow:0 2px 8px rgba(0,0,0,.08);
        }
        .brand{ display:flex; align-items:center; gap:.5rem; }
        .brand i{ font-size:1.5rem; }
        .brand strong{
          font-size:1.15rem; background:linear-gradient(135deg,var(--bg1),var(--bg2));
          -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
        }
        .menu-btn{ display:none; border:0; background:transparent; font-size:1.5rem; padding:.25rem .5rem; cursor:pointer; }
        nav.nav{
          max-width:1100px; margin:.35rem auto 0; display:flex; gap:.5rem; padding:.5rem 1rem;
          background:rgba(255,255,255,.9); border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08);
        }
        .nav a{
          text-decoration:none; color:#4a5568; font-weight:600;
          padding:.6rem 1rem; border-radius:8px; white-space:nowrap;
        }
        .nav a[aria-current="page"], .nav a:hover{
          color:#fff; background:linear-gradient(135deg,var(--bg1),var(--bg2));
        }

        .container{ max-width:1100px; margin:1rem auto 2rem; padding:0 1rem; }
        .page-header{
          background:#fff; border-radius:12px; padding:1.25rem 1.5rem; margin-bottom:1rem;
          box-shadow:0 2px 8px rgba(0,0,0,.08); border-left:4px solid var(--accent);
          text-align:center;
        }
        .page-header h1{ font-size:1.9rem; margin-bottom:.25rem; }
        .page-header p{ color:var(--muted); }

        .card{
          background:#fff; border-radius:12px; padding:1.25rem 1.5rem; margin-bottom:1rem;
          box-shadow:0 4px 12px rgba(0,0,0,.1);
        }
        .card h2{ margin-bottom:1rem; color:#667eea; }

        .tabs{ display:flex; gap:.5rem; margin-bottom:1rem; flex-wrap:wrap; }
        .tab-button{
          padding:.7rem 1.2rem; background:#fff; border:none; border-radius:8px; cursor:pointer;
          font-size:1rem; font-weight:600; transition:all .3s; box-shadow:0 2px 4px rgba(0,0,0,.1);
        }
        .tab-button:hover{ transform:translateY(-2px); box-shadow:0 4px 8px rgba(0,0,0,.2); }
        .tab-button.active{ background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:#fff; }

        .tab-content{ display:none; }
        .tab-content.active{ display:block; }

        .search-bar{ margin-bottom:1rem; }
        .search-bar input{
          width:100%; padding:.85rem; border:2px solid var(--ring); border-radius:8px;
          font-size:1rem;
        }
        .search-bar input:focus{ outline:none; border-color:var(--accent); }

        .table-container{ overflow-x:auto; }
        table{ width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; }
        thead th{
          background:linear-gradient(135deg,#0f172a,#1e293b); color:#fff; padding:.85rem;
          text-align:left; font-weight:600;
        }
        tbody td{ padding:.85rem; border-bottom:1px solid var(--ring); }
        tbody tr:hover{ background:#f8fafc; }
        tbody tr.maxed{ background:linear-gradient(90deg, #fee2e2 0%, #fef2f2 100%); }

        .center-cell{ text-align:center; }

        .badge{
          display:inline-block; padding:.25rem .65rem; border-radius:999px;
          font-size:.85rem; font-weight:600;
        }
        .badge.green{ background:#d1fae5; color:#065f46; }
        .badge.yellow{ background:#fef3c7; color:#92400e; }
        .badge.red{ background:#fee2e2; color:#991b1b; }

        .combo-list{ display:flex; flex-direction:column; gap:.75rem; }
        .combo-card{
          background:#f8fafc; padding:1rem 1.25rem; border-radius:8px; border-left:4px solid var(--bg2);
        }
        .combo-card.maxed{
          background:linear-gradient(90deg, #fee2e2 0%, #fef2f2 100%);
          border-left:4px solid #dc2626;
        }
        .combo-card h3{ color:#1f2937; margin-bottom:.5rem; font-size:1.05rem; }
        .combo-stats{
          display:flex; gap:1.5rem; flex-wrap:wrap; align-items:center;
          font-size:.9rem; color:#64748b;
        }
        .combo-stats strong{ color:#1f2937; font-size:1.1rem; }

        .loading{ text-align:center; padding:3rem; color:#fff; font-size:1.1rem; }
        .error{ background:#fee2e2; color:#991b1b; padding:1rem; border-radius:8px; margin:1rem 0; }

        @media (max-width:768px){
          .menu-btn{ display:block; }
          nav.nav{ display:none; flex-direction:column; }
          nav.nav.open{ display:flex; }
          .container{ padding:0 .75rem; }
          .tabs{ flex-direction:column; }
          .tab-button{ width:100%; }
          .page-header h1{ font-size:1.5rem; }
        }
    </style>
</head>
<body>
<header class="header">
    <div class="header-bar">
        <div class="brand">
            <i>üèÜ</i><strong>KOC Season 2</strong>
        </div>
        <button id="menuBtn" class="menu-btn">‚ò∞</button>
    </div>
    <nav id="siteNav" class="nav" aria-label="Primary">
        <a href="index.html">üë• Teams</a>
        <a href="index22.html">üìÖ Schedule</a>
        <a href="rules.html">üìã Rules</a>
        <a href="standings.html">üìä Standings</a>
        <a href="player-matchups.html" aria-current="page">üéæ Matchups</a>
    </nav>
</header>

<main class="container">
    <section class="page-header">
        <h1>üéæ Player Matchups</h1>
        <p>Singles limits and doubles partnerships tracking</p>
    </section>

    <div id="loading" class="loading">Loading data...</div>
    <div id="error" class="error" style="display:none;"></div>

    <div id="content" style="display:none;">
        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('singles')">Singles Cap</button>
            <button class="tab-button" onclick="switchTab('doubles')">Doubles Combos</button>
            <button class="tab-button" onclick="switchTab('players')">Player Stats</button>
        </div>

        <!-- Singles Cap -->
        <div id="singles" class="tab-content active">
            <div class="search-bar">
                <input type="text" id="search1" placeholder="üîç Search player..." onkeyup="filter('singles')">
            </div>
            <div class="card">
                <h2>Player Activity Overview</h2>
                <div class="table-container">
                    <table>
                        <thead>
                        <tr>
                            <th>Player</th>
                            <th class="center-cell">Total Days</th>
                            <th class="center-cell">Singles Days</th>
                            <th class="center-cell">Doubles Days</th>
                            <th class="center-cell">Singles Played</th>
                            <th class="center-cell">Doubles Played</th>
                            <th class="center-cell">Singles Status</th>
                        </tr>
                        </thead>
                        <tbody id="singles-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Player Stats -->
        <div id="players" class="tab-content">
            <div class="search-bar">
                <input type="text" id="search4" placeholder="üîç Search player..." onkeyup="filter('players')">
            </div>
            <div class="card">
                <h2>Complete Player Statistics</h2>
                <div class="table-container">
                    <table>
                        <thead>
                        <tr>
                            <th>Player</th>
                            <th class="center-cell">Total Days</th>
                            <th class="center-cell">Matches</th>
                            <th class="center-cell">Singles</th>
                            <th class="center-cell">Doubles</th>
                            <th class="center-cell">Record</th>
                            <th class="center-cell">Win %</th>
                        </tr>
                        </thead>
                        <tbody id="players-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Doubles Combos -->
        <div id="doubles" class="tab-content">
            <div class="search-bar">
                <input type="text" id="search2" placeholder="üîç Search combo..." onkeyup="filter('doubles')">
            </div>
            <div class="card">
                <h2>Doubles Partnerships (Limit: 3 days OR 6 matches)</h2>
                <div id="doubles-body" class="combo-list"></div>
            </div>
        </div>
    </div>
</main>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
    const firebaseConfig = {
      apiKey: "AIzaSyDbO0eP52i4t3V94bEiDcl7WoKbSrrM9VA",
      authDomain: "koc2-20fb8.firebaseapp.com",
      databaseURL: "https://koc2-20fb8-default-rtdb.firebaseio.com",
      projectId: "koc2-20fb8",
      storageBucket: "koc2-20fb8.firebasestorage.app",
      messagingSenderId: "317734341461",
      appId: "1:317734341461:web:1bcad5a1792fac0e46bddc"
    };

    const app = firebase.initializeApp(firebaseConfig);
    const db = app.database();

    // Mobile menu
    document.getElementById('menuBtn').onclick = () => {
      document.getElementById('siteNav').classList.toggle('open');
    };

    // Tab switching
    window.switchTab = (tab) => {
      document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
      event.target.classList.add('active');
    };

    // Search filter
    window.filter = (tab) => {
      const searchId = tab === 'singles' ? 'search1' : tab === 'doubles' ? 'search2' : 'search4';
      const search = document.getElementById(searchId).value.toLowerCase();
      const body = document.getElementById(`${tab}-body`);
      const items = tab === 'doubles' ? body.querySelectorAll('.combo-card') : body.querySelectorAll('tr');
      items.forEach(item => {
        item.style.display = item.textContent.toLowerCase().includes(search) ? '' : 'none';
      });
    };

    // Load and process data
    db.ref('season2Matches').on('value', (snap) => {
      const data = snap.val();
      if (!data) {
        document.getElementById('error').textContent = 'No data found';
        document.getElementById('error').style.display = 'block';
        document.getElementById('loading').style.display = 'none';
        return;
      }

      const singles = {};
      const doubles = {};
      const players = {}; // Track all player activity

      Object.values(data).forEach(match => {
        if (!match.lines) return;
        const date = match.ts ? new Date(match.ts).toISOString().split('T')[0] : null;

        match.lines.forEach(line => {
          const t1 = line.players?.team1 || [];
          const t2 = line.players?.team2 || [];
          const t1won = (line.setWins?.team1 || 0) > (line.setWins?.team2 || 0);

          // Track all players
          t1.concat(t2).forEach(p => {
            if (!players[p]) {
              players[p] = {
                w: 0, l: 0,
                allDays: new Set(),
                singlesDays: new Set(),
                doublesDays: new Set(),
                singles: 0,
                doubles: 0,
                singlesW: 0,
                singlesL: 0
              };
            }
            if (date) players[p].allDays.add(date);

            const won = t1.includes(p) ? t1won : !t1won;
            won ? players[p].w++ : players[p].l++;

            if (line.type === 'singles') {
              players[p].singles++;
              if (date) players[p].singlesDays.add(date);
              won ? players[p].singlesW++ : players[p].singlesL++;
            } else {
              players[p].doubles++;
              if (date) players[p].doublesDays.add(date);
            }
          });

          // Singles tracking
          if (line.type === 'singles') {
            t1.concat(t2).forEach(p => {
              if (!singles[p]) singles[p] = { w: 0, l: 0, days: new Set() };
              if (date) singles[p].days.add(date);
              if (t1.includes(p)) {
                t1won ? singles[p].w++ : singles[p].l++;
              } else {
                t1won ? singles[p].l++ : singles[p].w++;
              }
            });
          }

          // Doubles tracking
          if (line.type === 'doubles' && t1.length === 2 && t2.length === 2) {
            [t1, t2].forEach((team, idx) => {
              const key = team.slice().sort().join(' & ');
              if (!doubles[key]) doubles[key] = { w: 0, l: 0, days: new Set() };
              if (date) doubles[key].days.add(date);
              const won = idx === 0 ? t1won : !t1won;
              won ? doubles[key].w++ : doubles[key].l++;
            });
          }
        });
      });

      renderSingles(players);
      renderPlayers(players);
      renderDoubles(doubles);

      document.getElementById('loading').style.display = 'none';
      document.getElementById('content').style.display = 'block';
    });

    function renderSingles(playersData) {
      const arr = Object.entries(playersData).map(([p, d]) => ({
        p,
        totalDays: d.allDays.size,
        singlesDays: d.singlesDays.size,
        doublesDays: d.doublesDays.size,
        singlesPlayed: d.singles,
        doublesPlayed: d.doubles,
        singlesMaxed: d.singles >= 3
      })).sort((a, b) => {
        // Sort maxed singles first, then by total days
        if (a.singlesMaxed && !b.singlesMaxed) return -1;
        if (b.singlesMaxed && !a.singlesMaxed) return 1;
        return b.totalDays - a.totalDays || b.singlesPlayed - a.singlesPlayed;
      });

      document.getElementById('singles-body').innerHTML = arr.map(x => {
        const status = x.singlesMaxed ? 'MAXED' : `${3 - x.singlesPlayed} left`;
        const statusColor = x.singlesMaxed ? 'red' : x.singlesPlayed >= 2 ? 'yellow' : 'green';
        return `
          <tr class="${x.singlesMaxed ? 'maxed' : ''}">
            <td><strong>${x.p}</strong></td>
            <td class="center-cell"><strong>${x.totalDays}</strong></td>
            <td class="center-cell">${x.singlesDays}</td>
            <td class="center-cell">${x.doublesDays}</td>
            <td class="center-cell"><strong>${x.singlesPlayed}</strong>/3</td>
            <td class="center-cell">${x.doublesPlayed}</td>
            <td class="center-cell"><span class="badge ${statusColor}">${status}</span></td>
          </tr>
        `;
      }).join('') || '<tr><td colspan="7" class="center-cell" style="color:#718096;">No player data</td></tr>';
    }

    function renderPlayers(data) {
      const arr = Object.entries(data).map(([p, d]) => ({
        p, w: d.w, l: d.l, days: d.allDays.size, singles: d.singles, doubles: d.doubles,
        total: d.w + d.l
      })).sort((a, b) => b.days - a.days || b.total - a.total);

      document.getElementById('players-body').innerHTML = arr.map(x => {
        const pct = x.total > 0 ? (x.w / x.total * 100).toFixed(0) : 0;
        const color = pct >= 60 ? 'green' : pct >= 40 ? 'yellow' : 'red';
        return `
          <tr>
            <td><strong>${x.p}</strong></td>
            <td class="center-cell"><strong>${x.days}</strong></td>
            <td class="center-cell">${x.total}</td>
            <td class="center-cell">${x.singles}</td>
            <td class="center-cell">${x.doubles}</td>
            <td class="center-cell">${x.w}-${x.l}</td>
            <td class="center-cell"><span class="badge ${color}">${pct}%</span></td>
          </tr>
        `;
      }).join('') || '<tr><td colspan="7" class="center-cell" style="color:#718096;">No player data</td></tr>';
    }

    function renderDoubles(data) {
      const arr = Object.entries(data).map(([k, d]) => ({
        k, w: d.w, l: d.l, days: d.days.size, total: d.w + d.l
      })).sort((a, b) => {
        const aMax = a.days >= 3 || a.total >= 6;
        const bMax = b.days >= 3 || b.total >= 6;
        if (aMax && !bMax) return -1;
        if (bMax && !aMax) return 1;
        return b.total - a.total;
      });

      document.getElementById('doubles-body').innerHTML = arr.map(x => {
        const maxed = x.days >= 3 || x.total >= 6;
        const pct = x.total > 0 ? (x.w / x.total * 100).toFixed(0) : 0;
        const color = pct >= 60 ? 'green' : pct >= 40 ? 'yellow' : 'red';
        return `
          <div class="combo-card ${maxed ? 'maxed' : ''}">
            <h3>${x.k} ${maxed ? '<span class="badge red">MAXED</span>' : ''}</h3>
            <div class="combo-stats">
              <span>Matches: <strong>${x.total}</strong>/6</span>
              <span>Days: <strong>${x.days}</strong>/3</span>
              <span>Record: <strong>${x.w}-${x.l}</strong></span>
              <span>Win%: <span class="badge ${color}">${pct}%</span></span>
            </div>
          </div>
        `;
      }).join('') || '<p style="color:#718096;">No doubles data</p>';
    }
</script>
</body>
</html>