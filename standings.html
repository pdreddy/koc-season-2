<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Standings - KOC Season 2</title>
  <style>
    /* ===== Base / Theme (matches your site) ===== */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root{
      --bg1:#667eea; --bg2:#764ba2; --ink:#1a202c; --muted:#718096; --card:#ffffff;
      --ring:#e2e8f0; --accent:#22d3ee;
    }
    html,body{ height:100%; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100vh; color:var(--ink);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* ===== Header & Nav ===== */
    .header{ position:sticky; top:0; z-index:50; backdrop-filter:blur(10px); }
    .header-bar{
      display:flex; align-items:center; justify-content:space-between;
      max-width:1100px; margin:0 auto; padding:.75rem 1rem;
      background:rgba(255,255,255,.95); box-shadow:0 2px 8px rgba(0,0,0,.08);
    }
    .brand{ display:flex; align-items:center; gap:.5rem; }
    .brand i{ font-size:1.5rem; }
    .brand strong{
      font-size:1.15rem; background:linear-gradient(135deg,var(--bg1),var(--bg2));
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;
    }
    .menu-btn{ display:none; border:0; background:transparent; font-size:1.5rem; padding:.25rem .5rem; cursor:pointer; }
    nav.nav{
      max-width:1100px; margin:.35rem auto 0; display:flex; gap:.5rem; padding:.5rem 1rem;
      background:rgba(255,255,255,.9); border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,.08);
    }
    .nav a{
      text-decoration:none; color:#4a5568; font-weight:600;
      padding:.6rem 1rem; border-radius:8px; white-space:nowrap;
    }
    .nav a[aria-current="page"], .nav a:hover{
      color:#fff; background:linear-gradient(135deg,var(--bg1),var(--bg2));
    }

    /* ===== Layout ===== */
    .container{ max-width:1100px; margin:1rem auto 2rem; padding:0 1rem; }
    .page-header{
      background:#fff; border-radius:12px; padding:1.25rem 1.5rem; margin-bottom:1rem;
      box-shadow:0 2px 8px rgba(0,0,0,.08); border-left:4px solid var(--accent);
      text-align:center;
    }
    .page-header h1{ font-size:1.9rem; margin-bottom:.25rem; }
    .page-header p{ color:var(--muted); }

    .card{
      background:#fff; border-radius:12px; padding:1.25rem 1.5rem; margin-bottom:1rem;
      box-shadow:0 4px 12px rgba(0,0,0,.1);
    }
    .card h2{ margin-bottom:1rem; }

    /* ===== Access & Forms ===== */
    .access-card{ border:2px solid var(--accent); text-align:center; }
    .access-controls{ display:flex; gap:.6rem; justify-content:center; align-items:center; flex-wrap:wrap; }
    .access-input{
      padding:.7rem 1rem; border:2px solid var(--ring); border-radius:8px; min-width:240px;
    }
    .access-input:focus{ outline:none; border-color:var(--accent); }
    .btn{
      padding:.7rem 1.2rem; border:none; border-radius:8px; font-weight:800; color:#fff; cursor:pointer;
      background:linear-gradient(135deg,var(--bg1),var(--bg2)); box-shadow:0 2px 10px rgba(102,126,234,.35);
    }
    .btn.secondary{ background:#64748b; box-shadow:none; }
    .btn.success{ background:linear-gradient(135deg,#10b981,#059669); box-shadow:0 2px 10px rgba(16,185,129,.35); }
    .btn.warn{ background:linear-gradient(135deg,#f59e0b,#d97706); }
    .btn.danger{ background:linear-gradient(135deg,#ef4444,#dc2626); }
    .btn.ghost{ background:#fff; color:#1f2937; border:2px solid var(--ring); box-shadow:none; }

    .scoring-card{ border:2px solid var(--accent); background:linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%); }
    .card-header{ display:flex; justify-content:space-between; align-items:center; gap:.75rem; flex-wrap:wrap; }
    .tools{ display:flex; gap:.5rem; flex-wrap:wrap; }

    .match-form{
      display:grid; grid-template-columns:1fr auto 1fr; gap:1rem; align-items:start; margin-top:.25rem;
    }
    .team-input{
      display:flex; flex-direction:column; gap:.6rem; background:#fff; padding:1rem; border-radius:10px; border:2px solid var(--ring);
    }
    .input-label{ font-weight:800; text-align:center; }
    .select-input,.number-input{
      padding:.7rem; border:2px solid var(--ring); border-radius:8px;
    }
    .select-input:focus,.number-input:focus{ outline:none; border-color:var(--accent); }
    .inline{ display:flex; gap:.5rem; align-items:center; justify-content:space-between; }

    .legend{ color:var(--muted); font-size:.9rem; margin-top:.5rem; text-align:center; }

    .form-actions{ display:flex; gap:.6rem; justify-content:center; flex-wrap:wrap; margin-top:1rem; }
    .hidden{ display:none; }

    /* ===== Tables ===== */
    .table-container{ overflow-x:auto; }
    table{ width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; }
    thead th{
      background:linear-gradient(135deg,#0f172a,#1e293b); color:#fff; padding:.85rem; text-align:left;
    }
    tbody td{ padding:.85rem; border-bottom:1px solid var(--ring); }
    tbody tr:hover{ background:#f8fafc; }

    .standings-table tr.qualified{ background:linear-gradient(90deg,#d1fae5 0%, transparent 100%); }
    .standings-table tr.qualified:hover{ background:linear-gradient(90deg,#a7f3d0 0%, #f8fafc 100%); }

    .rank-cell{ font-weight:900; }
    .team-cell{ font-weight:800; }
    .center-cell{ text-align:center; }
    .points-cell{ font-weight:900; }

    .hint{ color:var(--muted); font-size:.9rem; margin-top:.35rem; }

    /* ===== Mobile ===== */
    @media (max-width:768px){
      .menu-btn{ display:block; }
      nav.nav{ display:none; flex-direction:column; }
      nav.nav.open{ display:flex; }
      .container{ padding:0 .75rem; }
      .match-form{ grid-template-columns:1fr; }
      .btn{ width:100%; }
      .card{ padding:1rem; }
    }
  </style>
</head>
<body>
<!-- Header -->
<header class="header">
  <div class="header-bar">
    <div class="brand" aria-label="KOC Season 2">
      <i>üèÜ</i><strong>KOC Season 2</strong>
    </div>
    <button id="menuBtn" class="menu-btn" aria-expanded="false" aria-controls="siteNav" aria-label="Toggle Menu">‚ò∞</button>
  </div>
  <nav id="siteNav" class="nav" aria-label="Primary">
    <!-- Order you asked for: Teams ‚Üí Schedule ‚Üí Rules ‚Üí Standings -->
    <a href="index.html">üë• Teams</a>
    <a href="index22.html">üìÖ Schedule</a>
    <a href="rules.html">üìã Rules</a>
    <a href="standings.html" aria-current="page">üìä Standings</a>
  </nav>
</header>

<main class="container">
  <section class="page-header">
    <h1>Tournament Standings</h1>
    <p>Live rankings and match results (stored in your browser)</p>
  </section>

  <!-- Access Code -->
  <section class="card access-card">
    <h2>üîí Score Entry Access</h2>
    <div class="access-controls" style="margin:.5rem 0;">
      <input type="password" id="accessCode" placeholder="Enter access code" class="access-input" />
      <button class="btn" id="unlockBtn">Unlock Scoring</button>
    </div>
    <p class="hint">Use access code <strong>SCORE2025</strong>. Data is saved in <em>localStorage</em>.</p>
  </section>

  <!-- Scoring Form -->
  <section id="scoringForm" class="card scoring-card hidden">
    <div class="card-header">
      <h2>üìù Add Match Result (Best-of-5)</h2>
      <div class="tools">
        <button class="btn secondary" id="lockBtn">Lock</button>
        <button class="btn ghost" id="exportBtn">Export JSON</button>
        <label class="btn ghost" for="importFile" style="cursor:pointer;">Import JSON</label>
        <input id="importFile" type="file" accept="application/json" class="hidden" />
      </div>
    </div>

    <div class="match-form">
      <div class="team-input">
        <label class="input-label">Team 1</label>
        <select id="team1Name" class="select-input" required>
          <option value="">Select Team 1</option>
        </select>
        <div class="inline">
          <label>Games Won</label>
          <input type="number" id="team1Games" placeholder="0‚Äì30" min="0" max="30" step="1" class="number-input" required />
        </div>
      </div>

      <div class="inline" style="align-self:center; font-weight:900; font-size:1.2rem;">VS</div>

      <div class="team-input">
        <label class="input-label">Team 2</label>
        <select id="team2Name" class="select-input" required>
          <option value="">Select Team 2</option>
        </select>
        <div class="inline">
          <label>Games Won</label>
          <input type="number" id="team2Games" placeholder="0‚Äì30" min="0" max="30" step="1" class="number-input" required />
        </div>
      </div>
    </div>

    <p class="legend">Universal Tennis format: enter total <strong>games won</strong> by each team (include the tiebreak game if played). Winner earns <strong>1 match point</strong>.</p>

    <div class="form-actions">
      <button class="btn success" id="addBtn">Save Result</button>
      <button class="btn warn" id="undoBtn" title="Remove the most recent match">Undo Last</button>
      <button class="btn danger" id="clearBtn" title="Clear ALL results">Clear All</button>
    </div>
  </section>

  <!-- Standings -->
  <section class="card standings-card">
    <h2>üìä Current Standings</h2>
    <div class="table-container">
      <table class="standings-table">
        <thead>
        <tr>
          <th>Rank</th>
          <th>Team</th>
          <th>Matches</th>
          <th>Match Wins</th>
          <th>Match Losses</th>
          <th>Games Won</th>
          <th>Games Lost</th>
          <th>Game Diff</th>
          <th>Match Points</th>
        </tr>
        </thead>
        <tbody id="standingsBody">
        <tr><td colspan="9" class="center-cell" style="color:var(--muted);">No results yet. Add a match to see standings.</td></tr>
        </tbody>
      </table>
    </div>
    <p class="hint">Sorted by Match Points ‚Üí Game Differential ‚Üí Games Won (top 4 highlighted).</p>
  </section>

  <!-- Match History -->
  <section class="card history-card">
    <h2>üìú Match History</h2>
    <div class="table-container">
      <table class="history-table">
        <thead>
        <tr>
          <th>#</th>
          <th>Teams</th>
          <th>Games</th>
          <th>Winner</th>
          <th>Date/Time</th>
        </tr>
        </thead>
        <tbody id="historyBody">
        <tr><td colspan="5" class="center-cell" style="color:var(--muted);">No matches recorded.</td></tr>
        </tbody>
      </table>
    </div>
  </section>
</main>

<script>
  /* ==========
     Storage & Teams
     ========== */
  const STORAGE_KEY = 'kocS2_matches';
  const TEAMS = [
    "Rally Royals",
    "Karna's Crusaders",
    "Spin Kings",
    "KOC Challengers", // Kings of the Court Challengers
    "Rally Squad",
    "Agni Aces",
    "Chill Titans",
    "Mega Lions",
    "Court Conquerors"
  ];

  function upgradeMatch(m){
    if(!m || !m.t1 || !m.t2) return null;
    const g1Raw = typeof m.g1 !== 'undefined' ? Number(m.g1) : Number(m.s1 ?? 0);
    const g2Raw = typeof m.g2 !== 'undefined' ? Number(m.g2) : Number(m.s2 ?? 0);
    if(!Number.isFinite(g1Raw) || !Number.isFinite(g2Raw)) return null;
    const g1 = Math.round(g1Raw);
    const g2 = Math.round(g2Raw);
    if(g1 < 0 || g2 < 0 || g1 > 40 || g2 > 40) return null;
    const derivedWin = g1 === g2 ? null : (g1 > g2 ? m.t1 : m.t2);
    const win = (m.win === m.t1 || m.win === m.t2) ? m.win : derivedWin;
    const tsNumber = Number(m.ts);
    const ts = Number.isFinite(tsNumber) ? tsNumber : Date.now();
    return { t1:m.t1, t2:m.t2, g1, g2, win, ts };
  }

  function loadMatches(){
    try {
      const raw = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      return raw.map(upgradeMatch).filter(Boolean);
    }
    catch { return []; }
  }
  function saveMatches(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }

  let matches = loadMatches(); // [{t1,t2,g1,g2,ts,win}]

  /* ==========
     UI: Nav (mobile)
     ========== */
  const menuBtn = document.getElementById('menuBtn');
  const siteNav = document.getElementById('siteNav');
  menuBtn.addEventListener('click', () => {
    const open = siteNav.classList.toggle('open');
    menuBtn.setAttribute('aria-expanded', String(open));
  });

  /* ==========
     Access Lock/Unlock
     ========== */
  const scoringForm = document.getElementById('scoringForm');
  document.getElementById('unlockBtn').addEventListener('click', () => {
    const code = (document.getElementById('accessCode').value || '').trim();
    if(code === 'SCORE2025'){
      scoringForm.classList.remove('hidden');
      document.getElementById('accessCode').value = '';
      alert('‚úÖ Scoring unlocked');
    } else {
      alert('‚ùå Invalid code');
    }
  });
  document.getElementById('lockBtn').addEventListener('click', () => {
    scoringForm.classList.add('hidden');
    alert('üîí Scoring locked');
  });

  /* ==========
     Populate selects
     ========== */
  const t1 = document.getElementById('team1Name');
  const t2 = document.getElementById('team2Name');
  function fillTeams(){
    const opts = ['<option value="">Select Team</option>', ...TEAMS.map(n=>`<option value="${n}">${n}</option>`)].join('');
    t1.innerHTML = opts.replace('Select Team','Select Team 1');
    t2.innerHTML = opts.replace('Select Team','Select Team 2');
  }
  fillTeams();

  /* ==========
     Validation helpers (UTR games-based)
     ========== */
  function validateGames(a,b){
    const g1 = Number(a), g2 = Number(b);
    if(!Number.isInteger(g1) || !Number.isInteger(g2)) return { ok:false, msg:'Enter whole-number games for both teams.' };
    if(g1<0 || g2<0) return { ok:false, msg:'Games cannot be negative.' };
    if(g1>40 || g2>40) return { ok:false, msg:'Games look unusually high. Please double check.' };
    if(g1 === g2) return { ok:false, msg:'Include the tiebreak game so one team has more games.' };
    return { ok:true };
  }

  /* ==========
     Derive standings from history
     ========== */
  function computeStandings(){
    const stats = {};
    TEAMS.forEach(n => stats[n] = {
      team:n,
      matches:0,
      wins:0,
      losses:0,
      gamesFor:0,
      gamesAgainst:0,
      points:0
    });
    for(const m of matches){
      // increment matches
      stats[m.t1].matches++; stats[m.t2].matches++;
      // games
      stats[m.t1].gamesFor += m.g1; stats[m.t1].gamesAgainst += m.g2;
      stats[m.t2].gamesFor += m.g2; stats[m.t2].gamesAgainst += m.g1;
      if(m.win === m.t1){
        stats[m.t1].wins++; stats[m.t2].losses++;
        stats[m.t1].points++;
      } else if(m.win === m.t2){
        stats[m.t2].wins++; stats[m.t1].losses++;
        stats[m.t2].points++;
      }
    }
    Object.values(stats).forEach(s => s.gameDiff = s.gamesFor - s.gamesAgainst);
    // sort: Match points ‚Üí Game differential ‚Üí Games for ‚Üí Name
    const arr = Object.values(stats)
      .sort((a,b)=>
        (b.points - a.points) ||
        (b.gameDiff - a.gameDiff) ||
        (b.gamesFor - a.gamesFor) ||
        a.team.localeCompare(b.team)
      );
    return arr;
  }

  function renderStandings(){
    const tbody = document.getElementById('standingsBody');
    const rows = computeStandings();

    if(matches.length === 0){
      tbody.innerHTML = '<tr><td colspan="9" class="center-cell" style="color:var(--muted);">No results yet. Add a match to see standings.</td></tr>';
      return;
    }

    tbody.innerHTML = rows.map((r,i)=>`
      <tr class="${i<4?'qualified':''}">
        <td class="rank-cell">${i+1}</td>
        <td class="team-cell">${r.team}</td>
        <td class="center-cell">${r.matches}</td>
        <td class="center-cell">${r.wins}</td>
        <td class="center-cell">${r.losses}</td>
        <td class="center-cell">${r.gamesFor}</td>
        <td class="center-cell">${r.gamesAgainst}</td>
        <td class="center-cell">${r.gameDiff}</td>
        <td class="points-cell">${r.points}</td>
      </tr>
    `).join('');
  }

  function renderHistory(){
    const tbody = document.getElementById('historyBody');
    if(matches.length === 0){
      tbody.innerHTML = '<tr><td colspan="5" class="center-cell" style="color:var(--muted);">No matches recorded.</td></tr>';
      return;
    }
    tbody.innerHTML = matches.map((m,idx)=>`
      <tr>
        <td class="rank-cell">${matches.length - idx}</td>
        <td class="team-cell">${m.t1} vs ${m.t2}</td>
        <td class="center-cell">${m.g1}-${m.g2}</td>
        <td class="points-cell">${m.win}</td>
        <td class="center-cell">${new Date(m.ts).toLocaleString()}</td>
      </tr>
    `).join('');
  }

  function refresh(){
    saveMatches(matches);
    renderStandings();
    renderHistory();
  }

  /* ==========
     Actions: Add / Undo / Clear / Import / Export
     ========== */
  document.getElementById('addBtn').addEventListener('click', () => {
    const a = t1.value.trim(), b = t2.value.trim();
    const g1 = Number(document.getElementById('team1Games').value);
    const g2 = Number(document.getElementById('team2Games').value);

    if(!a || !b) return alert('Select both teams.');
    if(a === b) return alert('A team cannot play itself.');
    const v = validateGames(g1,g2);
    if(!v.ok) return alert('‚ö†Ô∏è ' + v.msg);

    const win = g1 > g2 ? a : b;
    matches.unshift({ t1:a, t2:b, g1, g2, win, ts: Date.now() });

    // Clear inputs
    t1.value = ''; t2.value = '';
    document.getElementById('team1Games').value = '';
    document.getElementById('team2Games').value = '';

    refresh();
    alert(`‚úÖ Saved: ${a} ${g1}-${g2} ${b}\nWinner: ${win} (+1 match point)`);
  });

  document.getElementById('undoBtn').addEventListener('click', () => {
    if(matches.length === 0) return alert('Nothing to undo.');
    const last = matches[0];
    if(!confirm(`Undo last match?\n${last.t1} ${last.g1}-${last.g2} ${last.t2}`)) return;
    matches.shift();
    refresh();
  });

  document.getElementById('clearBtn').addEventListener('click', () => {
    if(matches.length === 0) return alert('Nothing to clear.');
    if(!confirm('Clear ALL match results?')) return;
    matches = [];
    refresh();
  });

  document.getElementById('exportBtn').addEventListener('click', () => {
    const blob = new Blob([JSON.stringify(matches,null,2)], { type:'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'koc-season2-matches.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById('importFile').addEventListener('change', (e) => {
    const file = e.target.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      try{
        const data = JSON.parse(reader.result);
        if(!Array.isArray(data)) throw new Error('Invalid JSON shape');
        // quick sanity check
        const upgraded = data.map(entry => {
          const u = upgradeMatch(entry);
          if(!u) throw new Error('Malformed match entry (invalid games)');
          if(!TEAMS.includes(u.t1) || !TEAMS.includes(u.t2)) throw new Error('Unknown team in data');
          if(u.win !== u.t1 && u.win !== u.t2) throw new Error('Match is missing a winner');
          return u;
        });
        matches = upgraded;
        refresh();
        alert('‚úÖ Import successful.');
      } catch(err){
        console.error(err);
        alert('‚ùå Import failed: ' + err.message);
      } finally {
        e.target.value = '';
      }
    };
    reader.readAsText(file);
  });

  /* ==========
     Initial render
     ========== */
  refresh();
</script>
</body>
</html>
